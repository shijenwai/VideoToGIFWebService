# T-20251207-002-動態並發排隊機制

## Summary
實作基於 `asyncio.Semaphore` 的排隊機制，透過環境變數動態控制並發數量，保護低規格伺服器資源。

## Why
原本 Bot 使用 `concurrent_updates=True` 允許無限並發，在 Render 免費方案（0.1 CPU / 512MB）上多人同時使用會導致資源耗盡、轉檔失敗或服務崩潰。

## Scope

### In Scope
- [x] 新增 `MAX_CONCURRENT` 環境變數
- [x] 實作 `asyncio.Semaphore` 排隊機制
- [x] 更新 README 環境變數說明
- [x] 建立並發配置指南文件

### Out of Scope
- 分散式佇列系統（見 T-20251207-001）
- 排隊狀態通知使用者
- 佇列優先級機制

## Acceptance Criteria
- [x] `MAX_CONCURRENT=1` 時，多人上傳會依序處理
- [x] 環境變數可動態調整並發數量
- [x] Bot 啟動時顯示並發配置 log
- [x] 程式碼無語法錯誤

## Implementation Steps
1. 在 `app.py` 新增全域變數讀取 `MAX_CONCURRENT`（預設 1）
2. 建立 `asyncio.Semaphore(MAX_CONCURRENT)` 實例
3. 在 `video_to_gif_handler` 使用 `async with processing_semaphore:` 包裹處理邏輯
4. 更新 `README.md` 新增環境變數說明
5. 建立 `docs/CONCURRENCY_CONFIG.md` 詳細配置指南

## Test/Validation
- [x] 程式碼通過 lint 檢查
- [ ] 本地測試同時上傳 2 個影片，確認排隊行為
- [ ] 部署後驗證 log 顯示正確並發數

## Story Points
2

## Status
- [ ] 待處理
- [ ] 進行中
- [ ] 待測試
- [ ] 待審核
- [x] 已完成

## Notes

### 修改檔案
- `app.py`：新增 Semaphore 排隊邏輯
- `README.md`：新增 `MAX_CONCURRENT` 環境變數說明
- `docs/CONCURRENCY_CONFIG.md`：新增詳細配置指南

### 配置建議
| 伺服器規格 | MAX_CONCURRENT |
|-----------|----------------|
| 0.1 CPU / 512MB | 1 |
| 0.5 CPU / 1GB | 2 |
| 1 CPU / 2GB | 3-4 |
| 2+ CPU / 4GB+ | 5-8 |

### 相關 Ticket
- T-20251207-001：分散式佇列系統升級（未來擴展）
